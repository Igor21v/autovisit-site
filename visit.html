<iframe
  src="https://webitem.ru/"
  id="iframe"
  width="1000"
  height="700"
></iframe>

<button style="width: 1000; height: 40px" onclick="onClick()" id="button">
  Запустить обход
</button>

<div id="state">Загрузка sitemap...</div>

<script>
  const xhr = new XMLHttpRequest();
  let nodePaths;
  const state = document.getElementById("state");
  const button = document.getElementById("button");
  let totalPages = 0;

  // Загрузка sitemap
  xhr.onload = () => {
    if (xhr.status == 200) {
      const xml = xhr.responseXML;
      nodePaths = xml.querySelectorAll("loc");
      totalPages = nodePaths.length;
      state.textContent = `Sitemap загружен, всего записей: ${totalPages}. Настройте агент пользователя и запустите обход`;
    }
  };
  xhr.open("GET", "https://webitem.ru/static/sitemap.xml"); // GET-запрос к /data
  xhr.responseType = "document"; // устанавливаем тип ответа
  xhr.setRequestHeader("Accept", "text/xml"); // принимаем только xml
  xhr.send(); // выполняем запрос */

  // Запуск обхода
  let currPage = 40;
  let isProcess = false;
  let timeout;
  async function onClick() {
    if (!isProcess) {
      button.textContent = `Приостановить обход`;
      isProcess = true;
      changePage(currPage);
    } else {
      isProcess = false;
      button.textContent = `Восстановить обход`;
      clearInterval(timeout);
    }
    function changePage(page) {
      currPage = page;
      state.textContent = `Запущен обход. Обработано ${page} из ${totalPages}.`;
      iframe.contentWindow.location = nodePaths[page].textContent;
      console.log(nodePaths[page].textContent);
      page++;
      if (page < totalPages && isProcess) {
        timeout = setTimeout(() => {
          changePage(page);
        }, 30000);
      } else {
        state.textContent = `Обход остановлен, обработано страниц: ${page} из ${totalPages}.`;
      }
    }
  }
</script>
